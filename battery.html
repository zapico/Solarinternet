<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Battery reading - </title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Battery reading</title> <meta name="generator" content="Jekyll v4.2.2" /> <meta property="og:title" content="Battery reading" /> <meta property="og:locale" content="en_US" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Battery reading" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","headline":"Battery reading","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/logo2.png"}},"url":"/battery.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/project.html" class="nav-list-link">The Project</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/servers.html" class="nav-list-link">Solar Servers</a><ul class="nav-list "><li class="nav-list-item "><a href="/p01.html" class="nav-list-link">01 Raspberry pi</a></li><li class="nav-list-item "><a href="/p02.html" class="nav-list-link">02 Powerbank Zero</a></li><li class="nav-list-item "><a href="/p03.html" class="nav-list-link">03 Pi Cluster</a></li><li class="nav-list-item "><a href="/p04.html" class="nav-list-link">04 Grid version</a></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/instructions.html" class="nav-list-link">Instructions</a><ul class="nav-list "><li class="nav-list-item active"><a href="/battery.html" class="nav-list-link active">Battery reading</a></li><li class="nav-list-item "><a href="/routing.html" class="nav-list-link">Routing</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/discussion.html" class="nav-list-link">Discussions</a><ul class="nav-list "></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search " aria-label="Search " autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/instructions.html">Instructions</a></li> <li class="breadcrumb-nav-list-item"><span>Battery reading</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1> Battery status reading </h1> <p>Reading the charging status of a battery is not as straightforward as it would seem. Victron energy provides this information from some of their MPPTs through a propietary port called VE.direct. If using an MPTT wihout port, an external battery monitor can be installed, like <a href="https://www.victronenergy.com/battery-monitors/smart-battery-shunt">Victron Smart Battery Shunt</a>. Then one needs a <a href="https://www.victronenergy.com/accessories/ve-direct-to-usb-interface">VE.direct to USB cable</a> to connect the MPPT/shunt to the server through USB.</p> <p>Once the setup is working the data can be read using serial. The port should be updated to reflect where the cable is connected.</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">serial</span>
<span class="n">sio</span> <span class="o">=</span> <span class="n">serial</span><span class="p">.</span><span class="n">Serial</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="s">'/dev/ttyUSB0'</span><span class="p">,</span><span class="n">baudrate</span><span class="o">=</span><span class="mi">19200</span><span class="p">,</span><span class="n">parity</span><span class="o">=</span><span class="n">serial</span><span class="p">.</span><span class="n">PARITY_NONE</span><span class="p">,</span><span class="n">stopbits</span><span class="o">=</span><span class="n">serial</span><span class="p">.</span><span class="n">STOPBITS_ONE</span><span class="p">,</span><span class="n">bytesize</span><span class="o">=</span><span class="n">serial</span><span class="p">.</span><span class="n">EIGHTBITS</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</code></pre></div></div> <p>Detail information about the VE protocol can be found in the <a href="https://www.victronenergy.com/support-and-downloads/technical-information">VE.direct protocel whitepaper</a>. For our application we just use battery charge and load in watt. First all lines are read one by one, this can be printed to identify other values that may be interesting.</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">line</span> <span class="o">=</span> <span class="n">sio</span><span class="p">.</span><span class="n">readline</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">'iso-8859-1'</span><span class="p">)</span>
</code></pre></div></div> <p>The the lines for power in Watt and percentage of battery are identified and the value extracted from the string.</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"P	"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
  <span class="n">kw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
<span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"SOC"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
  <span class="n">battery</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span><span class="o">/</span><span class="mi">10</span>
</code></pre></div></div> <p>The whole code can be found below and at <a href="https://github.com/zapico/SolarServer">github</a>. It saves the data in a json file for the website to read, but the data can be saved in a database, sent using MQTT or any other option. It reads the data every 10 minutes, this can be changed in the time.sleep() line.</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">serial</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Connect to serial
</span><span class="n">sio</span> <span class="o">=</span> <span class="n">serial</span><span class="p">.</span><span class="n">Serial</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="s">'/dev/ttyUSB0'</span><span class="p">,</span><span class="n">baudrate</span><span class="o">=</span><span class="mi">19200</span><span class="p">,</span><span class="n">parity</span><span class="o">=</span><span class="n">serial</span><span class="p">.</span><span class="n">PARITY_NONE</span><span class="p">,</span><span class="n">stopbits</span><span class="o">=</span><span class="n">serial</span><span class="p">.</span><span class="n">STOPBITS_ONE</span><span class="p">,</span><span class="n">bytesize</span><span class="o">=</span><span class="n">serial</span><span class="p">.</span><span class="n">EIGHTBITS</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"connected to: "</span> <span class="o">+</span> <span class="n">sio</span><span class="p">.</span><span class="n">portstr</span><span class="p">)</span>
<span class="c1"># Init variables
</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span>
<span class="n">kw</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">battery</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># Loop
</span><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c1"># Check that serial has read both values
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">kw</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">battery</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">battery</span><span class="o">==</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{</span>
           <span class="s">"kw"</span><span class="p">:</span> <span class="n">kw</span><span class="p">,</span>
           <span class="s">"battery"</span><span class="p">:</span> <span class="n">battery</span><span class="p">,</span>
           <span class="s">"time"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>
        <span class="p">}</span>
        <span class="c1"># Save as status json and to history
</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"/var/www/thehackfarm/html/battery.json"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="c1"># Append to history.json. This dictionary can then be read with:
</span>        <span class="c1"># with open('my_file') as f:
</span>        <span class="c1">#   my_list = [json.loads(line) for line in f]
</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'/var/www/thehackfarm/html/history.json'</span><span class="p">,</span> <span class="s">'a'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">linesep</span><span class="p">)</span>
        <span class="c1"># Reset numbers and sleep for 10 minutes
</span>        <span class="n">kw</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">battery</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">600</span><span class="p">)</span>

    <span class="n">line</span> <span class="o">=</span> <span class="n">sio</span><span class="p">.</span><span class="n">readline</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">'iso-8859-1'</span><span class="p">)</span>
    <span class="c1"># read kwh in
</span>    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">line</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"P	"</span><span class="p">)):</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
        <span class="k">print</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>
    <span class="c1"># read battery
</span>    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">line</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"SOC"</span><span class="p">)):</span>
       <span class="n">battery</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span><span class="o">/</span><span class="mi">10</span>
       <span class="k">print</span><span class="p">(</span><span class="n">battery</span><span class="p">)</span>

</code></pre></div></div> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
